---
layout: post
title:  "Atom baytrail 미니 PC에서 tvheadend 사용하기 - 1"
date:   2018-04-11 09:01:07.025 +0900
categories: [ 서버, 일상 ]
tags: [ atom, baytrail, ubuntu, server, 저전력서버 ]
---

### 한동안 뜸했다. 이번에 사용해보는 미니 PC는 

지금의 HP Microserver N54l에서 XPEnology가 돌아가기 전에 NAS 목적으로 사용하려다 실패한 제품이다. Baytrail 아키텍쳐 쿼드코어인 아톰이 달린 저전력 CPU 온보드 모델인데, 개발 중지된 값싼 NDAS 의 구버전 커널용 드라이버를 업그레이드 한답시고 20여일 동안 삽질만 하다가 서랍에 처박았었다. 한 이틀 사용하다 보면 어느새 다운되어 있었기 때문이었다. 드라이버 문제라기 보다는 baytrail을 구버전 커널이 제대로 지원하지 않기 때문으로 보였다. 베이트레일 시리즈 2 in 1 제품들 특성이 워낙 변태같기도 했고, 애초에 윈도우용 머신으로 나온 까닭에, 개발자들의 관심을 그닥 끌지 못해 최적화 작업이 늦게 이루어졌기 때문이다. 몇 가지 예시를 들자면, atom 프로세서는 64비트를 지원함에도 BIOS는 32bit 버전의 UEFI가 들어 있다는 것이다. CSM도 지원하지 않아 legacy 부트 모드도 지원하지 않는다. 이 말인즉슨, 일반적인 우분투 16.04 를 USB에 구워 설치해봤자 우분투의 보라색 화면을 구경도 못 한다는 뜻이다. 부트 로더 튜닝 과정이 없으면 심지어 USB로 부팅도 되지 않는다. 64비트 EFI 파일을 32비트 UEFI에서 읽지 못하기 때문이다. 반면에 사이트에서 다운받는 32비트 우분투 이미지는 EFI 부트를 지원하지 않는다. *애초에 윈도우용 머신으로 나왔다*는 것이 바로 이 때문이다. 마이크로소프트가 괜히 베이트레일 윈도우 머신에 들어가는 윈도우를 업체들에게 *거저* 준 것이 아니다. *윈도우만* (쉽게) 쓸 수 있게 만들었기 때문이다.

그렇다고 불가능한 것도 아니다. 이전에도 물론 이 기기에 우분투를 설치한 적은 있었다. 멀티 아키텍쳐를 지원하는 데비안 버전에서 32bit 용 efi 파일을 추출하여 직접 수작업으로 USB의 부트 스크립트를 수정하여 설치하고, 같은 방식으로 설치된 우분투의 부트로더 역시 수정하여 사용했었다. 그렇지만 그것은 몇 년 전 이야기였고, 수요가 무척 많았던 baytrail 아톰 계열의 PC인 만큼 *선구자*들이 개척한 길을 찾아보기로 했다.

그러다 [linuxium](http://www.linuxium.com.au/) 을 발견했다. 어떤 쉘 스크립트 장인의 작품인지는 모르겠지만, 우분투 데스크탑 버전의 iso를 다운받아 이 스크립트를 적용시키면, 더 많은 하드웨어를 지원하는 커널(HWE: Hardware Enablement: 하드웨어 지원 강화)인 `4.13` 버전으로 커널교체는 물론 아톰계열의 미니 PC에서 설치도 원활하게 되는 이미지로 탈바꿈시킨다. 물론 이것도 완벽하지는 않았는데, baytrail CPU의 고질적인 문제인 자동 절전 모드 진입 후 복귀하지 못하는 문제는 여전했다(실은 이것이 이전의 그 *안쓰면 죽어버리는* 문제의 원인이었다). `/etc/default/grub`파일에서 `intel_idle.max_cstate=1` 옵션을 `GRUB_CMDLINE_LINUX_DEFAULT` 환경변수에 추가해주면 해당 기능이 비활성화되는 듯 싶다. 약 열흘 동안 까먹고 사용하지 않아도 다운되지 않는 것을 보면 어느정도 입증되었다고 봐도 무방해 보인다([출처](https://askubuntu.com/questions/803640/system-freezes-completely-with-intel-bay-trail)). 

서버로 사용하기 위한 한 가지가 더 있는데, 모니터 떼고 SSH로 터미널만 쓸 것이기 때문에 gui를 활성화시킬 필요가 없었다. 쓸데없이 메모리만 차지할 것이다. 이것도 알고 보면 간단한데, 좀 전에 수정한 grub파일을 다시 열고 몇 가지만 더 수정하면 된다([출처](https://askubuntu.com/questions/16371/how-do-i-disable-x-at-boot-time-so-that-the-system-boots-in-text-mode))

여기까지가 baytrail 계열 미니 PC - 인텔 컴퓨트 스틱 등 - 을 저전력 서버로 가지고 놀기 위한 최소한의 세팅이다. 이후는 tvheadend를 docker로 설치하고 방화벽을 설정하는 과정이 이어지겠다. 참고로 본인의 미니 PC는 중고로 6만원에 구입한 [이 모델](https://www.aliexpress.com/item/2015-Newest-Vmsart-X1-windows-8-1-OS-Intel-Quad-Core-1-5Ghz-CPU-Mini-PC/32257704643.html)이다.
